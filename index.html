<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>CompGraf2 AF</title>

    <!-- Babylon.js -->
    <script src="https://code.jquery.com/pep/0.4.2/pep.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/ammo.js"></script>
    <script src="https://preview.babylonjs.com/cannon.js"></script>
    <script src="https://preview.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        // VINICIUS IBANEZ ALVES 180023
        // VICTOR MARCIANO 180131

        var canvas = document.getElementById("renderCanvas");
        const objectsConfig = {
            "backGround": {
                "position": [0, 0, .05],
                "size": { height: 20, width: 20, depth: 0.1 },
                "color": "#7B7D7D",
                "texture": "assets/albedo.jpg"
            },
            "trigger": {
                "triggerBackGround": {
                    "position": [-8, -5, 0],
                    "size": { height: 1.5, width: 1.2, depth: 0.1 },
                    "color": "#7B7D7D"
                },
                "triggerButton": {
                    "position": [-8, -5, -.05],
                    "size": { height: 1, width: .4, depth: 0.1 },
                    "color": "#C2CB00"
                }
            },
            "platform": {
                "startingPoint": {
                    "color": "#010101",
                    "size": { height: .2, width: 1.8, depth: 0.5 },
                    "position": [-8, 8, -.2]
                },
                "sphere1": {
                    "size": .3,
                    "color": "#010101",
                    "position": [-8, 8.3, -.3]
                },
                "tube1": {
                    "size": 1,
                    "position": [-5.5, 5.9, -.45],
                    "rotation": -1,
                    "color": "#FFFFFF"

                },
                "platform1": {
                    "color": "#010101",
                    "size": { height: .2, width: 4, depth: 1 },
                    "position": [-4, 5, -.4],
                    "rotation": '-5'
                },
                "domino" : {
                    "color": "#FFFFFF",
                    "spacement": "",
                    "pieces": [
                        {
                         "size": { height: 1, width: .1, depth: .5 },
                         "position":[-4.5, 5.6, -.4],
                         "mass": 2.2
                        },
                        {
                         "size": { height: 1.5, width: .1, depth: .5 },
                         "position":[-3.8, 5.9, -.2],
                         "mass": 2.2
                        },
                        {
                         "size": { height: 2, width: .1, depth: .5 },
                         "position":[-2.5, 6.3, -.2],
                         "mass": 2.2
                        }
                    ]
                },
                "platform2": { 
                    "color": "#010101",
                    "size": { height: .2, width: 4, depth: 1 },
                    "position": [-4, 5, -.4],
                    "rotation": '-5'
                },
                "boxes": {
                    "color": "#FFFFFF",
                    "pieces": [
                        {
                            "color": "#010101",
                            "size": { height: .2, width: 4, depth: 1 },
                            "position": [-4, 5, -.4],
                            "rotation": '-5'
                        },
                        {
                            "color": "#010101",
                            "size": { height: .2, width: 4, depth: 1 },
                            "position": [-4, 5, -.4],
                            "rotation": '-5'
                        }
                    ]
                }
            }
        }

        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function () {
            return new BABYLON.Engine(canvas, true, {
                preserveDrawingBuffer: true,
                stencil: true,
                disableWebGL2Support: false
            });
        };

        const createScene = () => {
            const scene = new BABYLON.Scene(engine);
            setupScene(scene);
            createScenario(scene, objectsConfig);
            listenClickEvent(scene)
            return scene;
        }

        setupScene = function (scene) {
            const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, 1.7 * Math.PI / 2.5, 30, new BABYLON.Vector3(-2.5, 1, 2));
            camera.attachControl(canvas, true);
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0));
            const light2 = new BABYLON.HemisphericLight("light2", new BABYLON.Vector3(0, 10, -10));
            const light3 = new BABYLON.HemisphericLight("light3", new BABYLON.Vector3(0, 10, 10));
            scene.enablePhysics();
        }

        function listenClickEvent(scene) {
            scene.onPointerDown = function (evt, pickResult) {
                if (pickResult.hit) {
                    if(pickResult.pickedMesh.id == 'triggerButton'){
                        console.log(pickResult.pickedMesh.id);
                    picked_mesh = scene.getMeshesByID('startingPoint')[0];
                    picked_mesh.rotate(new BABYLON.Vector3(0, 0, 1), -.2, BABYLON.Space.LOCAL);
                    }
                   

                }
            };
        }

        createScenario = function (scene, objectsConfig) {

            createBackground(scene, objectsConfig);
            createTrigger(scene, objectsConfig);
            createPlatform(scene, objectsConfig);

        }
        createBackground =  function(scene, objectsConfig){
            backGroundMesh = new BABYLON.Mesh('backGroundMesh', scene);

            // Creating the Background
            id = 'backGround'
            config =  objectsConfig[id]

            // Material 
            var backGroundMaterial = new BABYLON.StandardMaterial("backGroundMaterial", scene);
            backGroundMaterial.diffuseTexture  = new BABYLON.Texture(config['texture'], scene);

            // Mesh
            const backGround = BABYLON.MeshBuilder.CreatePlane(id, config['size']);
            backGround.position = new BABYLON.Vector3(config['position'][0],
                config['position'][1],
                config['position'][2]
            )
            backGround.material = backGroundMaterial;
            
            backGroundMesh.addChild(backGround);

        }

        createTrigger = function (scene, objectsConfig) {

            triggerMesh = new BABYLON.Mesh('triggerMesh', scene);

            
            id = 'trigger'
            config = objectsConfig[id]

            // Creating trigger BackGround
            backGroundId = 'triggerBackGround'

            // Material
            var triggerbackGroundMaterial = new BABYLON.StandardMaterial("triggerbackGroundMaterial", scene);
            triggerbackGroundMaterial.diffuseColor = BABYLON.Color3.FromHexString(config[backGroundId]['color'])

            // Mesh
            var triggerBackGround = BABYLON.MeshBuilder.CreateBox(backGroundId, config[backGroundId]['size']);
            triggerBackGround.material = triggerbackGroundMaterial
            triggerBackGround.position = new BABYLON.Vector3(config[backGroundId]['position'][0],
                config[backGroundId]['position'][1],
                config[backGroundId]['position'][2]
            )

            // Creating trigger      
            triggerId = 'triggerButton'
            // Material
            var triggerMaterial =  new BABYLON.StandardMaterial("triggerMaterial", scene);
            triggerMaterial.diffuseColor = BABYLON.Color3.FromHexString(config[triggerId]['color'])
            // Mesh
            var triggerButton = BABYLON.MeshBuilder.CreateBox(triggerId, config[triggerId]['size']);
            triggerButton.material = triggerMaterial
            setPosition(triggerButton,config[triggerId]['position']);

            triggerMesh.addChild(triggerBackGround);
            triggerMesh.addChild(triggerButton);
        },

        createPlatform = function(scene, objectsConfig){
            
            platformMesh = new BABYLON.Mesh('platformMesh', scene);

            id = 'platform'
            config = objectsConfig[id]
            
            // Creating Starting point
            id = 'startingPoint'
            startingPointConfig = config[id];

                //Material    
                var startingPointMaterial =  new BABYLON.StandardMaterial('startPointMaterial', scene);
                startingPointMaterial.diffuseColor = BABYLON.Color3.FromHexString(startingPointConfig['color'])

                //Start Mesh
                var startingPoint = BABYLON.MeshBuilder.CreateBox(id, startingPointConfig['size']);
                startingPoint.material = startingPointMaterial;
                setPosition(startingPoint,startingPointConfig['position']);
                startingPoint.physicsImpostor = new BABYLON.PhysicsImpostor(startingPoint, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0.9 }, scene);
                platformMesh.addChild(startingPoint);
            
            // Creating Sphere 1
            id  = 'sphere1'
            sphere1Config = config[id];

                //Material
                var sphere1Material =  new BABYLON.StandardMaterial('sphere1Material', scene);
                startingPointMaterial.diffuseColor = BABYLON.Color3.FromHexString(sphere1Config['color'])

                // Sphere1 Mesh
                var sphere1 = BABYLON.Mesh.CreateSphere(id, 16, sphere1Config['size'], scene);
                sphere1.material = sphere1Material;
                setPosition(sphere1, sphere1Config['position']);
                sphere1.physicsImpostor = new BABYLON.PhysicsImpostor(sphere1, BABYLON.PhysicsImpostor.SphereImpostor, { mass: 2, restitution: 0.9 }, scene);
                platformMesh.addChild(sphere1);


            // Creating Cylindir 1 
            id = 'tube1';
            tube1Config =  config[id];

                // Material
                var tube1Material =  new BABYLON.StandardMaterial(id, scene);
                tube1Material.diffuseColor = BABYLON.Color3.FromHexString(tube1Config['color']);
                tube1Material.alpha = 1.0;
                tube1Material.backFaceCulling = false;

                // Tube1 Mesh
                var tube1 =  createCylinder(id, tube1Config);
                tube1.material =  tube1Material;
                platformMesh.addChild(tube1)


             // Creating platform 1
             id = 'platform1'
             platform1Config = config[id];

                //Material    
                var platform1Material =  new BABYLON.StandardMaterial('platform1Material', scene);
                platform1Material.diffuseColor = BABYLON.Color3.FromHexString(platform1Config['color'])

                //Start Mesh
                var platform1 = BABYLON.MeshBuilder.CreateBox(id, platform1Config['size']);
                platform1.material = startingPointMaterial;
                setPosition(platform1,platform1Config['position']);
                platform1.physicsImpostor = new BABYLON.PhysicsImpostor(platform1, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0.0 }, scene);
                platformMesh.addChild(platform1);

            // Create Domino

            id = 'domino'
            config  = config[id];
            createDomino(id, config, scene);

            
        }

        function setPosition(mesh, position){
            mesh.position = new BABYLON.Vector3(position[0],
            position[1],
            position[2]
            )
        }
        
        createCylinder = function (id, config) {
            var sideOrientation = BABYLON.Mesh.FRONTSIDE;
            var radius = 5;
            var path = [];
            for (var i = -config['size']; i < config['size']; i++) {
                var x = i * 2;
                var y = 0;
                var z = 0;
                path.push(new BABYLON.Vector3(x, y, z));
            }
            var mesh = BABYLON.Mesh.CreateTube(id, path, .3, 16, null, 0, scene, true, sideOrientation);
            mesh.rotate(new BABYLON.Vector3(0, 0, 1), config['rotation'], BABYLON.Space.LOCAL);
            mesh.physicsImpostor = new BABYLON.PhysicsImpostor(mesh, BABYLON.PhysicsImpostor.MeshImpostor, { mass: 0, restitution: 0.9 }, scene);
            setPosition(mesh,config['position'])
            return mesh
        }

        createDomino = function (id, config, scene) {
            
            var dominoMaterial =  new BABYLON.StandardMaterial('dominoMaterial', scene);
            dominoMaterial.diffuseColor = BABYLON.Color3.FromHexString(config['color']);
            for (i in config['pieces']){
                element = config['pieces'][i];
            var dominoPiece = BABYLON.MeshBuilder.CreateBox('dominoPiece', element['size'], scene);
            setPosition(dominoPiece, element['position']);
            dominoPiece.material =  dominoMaterial;
            dominoPiece.physicsImpostor = new BABYLON.PhysicsImpostor(dominoPiece, BABYLON.PhysicsImpostor.BoxImpostor, { mass: element['mass'], restitution: 0.0 }, scene);
            }
            
        }


        var engine;
        var scene;

        sleep = async function (time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }
        initFunction = async function () {
            var asyncEngineCreation = async function () {
                try {
                    return createDefaultEngine();
                } catch (e) {
                    console.log("the available createEngine function failed. Creating the default engine instead");
                    return createDefaultEngine();
                }
            }

            engine = await asyncEngineCreation();
            if (!engine) throw 'engine should not be null.';
            scene = createScene();
        };

        initFunction().then(() => {
            sceneToRender = scene
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>

</html>